#!/usr/bin/env bash
set -euo pipefail
r="$HOME/.codex/sessions"
f=$(ls -t "$r"/*/*/*/*.jsonl 2>/dev/null | head -n1)
[ -n "${f:-}" ] || exit 1
line=$(
jq -r '
  select(.type=="event_msg" and .payload.type=="token_count")
  | [
      (.payload.rate_limits.primary.used_percent // ""),
      (.payload.rate_limits.secondary.used_percent // ""),
      (.payload.info.total_token_usage.total_tokens // ""),
      (.payload.info.last_token_usage.total_tokens // "")
    ]
  | @tsv
' "$f" | tail -n1 || true)
[ -n "$line" ] || exit 1
printf '%s\n' "$line"
